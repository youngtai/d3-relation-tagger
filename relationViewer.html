<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <script type="text/javascript" src="http://livejs.com/live.js"></script>
    <link rel="stylesheet" type="text/css" href="resources/enamex-tag-style.css">
    <link rel="stylesheet" type="text/css" href="resources/page-style.css">
    <link rel="icon" href="resources/1200px-Directed.png"> 
</head>
<div id = "page">
  <div id = "top-panel">
    <div id="file-io">
      <div id = "file-intake">
        <input type="file" id="file-intake-button">
      </div>
      <button id="export" type="button">Export</button>
    </div>
    <div id="option-buttons">
      <button id="toggle-same-as" type="button">Show "Same As"</button>
      <button id="scissors" type="button">Scissors</button>
      <button id="reload-displayedGraph" type="button">All Relations</button>
    </div>
  </div>

  <div id="main">
    <div id="data-display">
        <div id="text-container">
          <div id="text-div">Labeled text shows up here.</div>
        </div>
        <div id="svg-container">
          <svg id="simulation-display-space"></svg>
        </div>
    </div>
    <div id="relationships-panel">
      <button class="relationship-button" id="has-start-date" type="button">has start date</button>
      <button class="relationship-button" id="has-start-place" type="button">has start place</button>
      <button class="relationship-button" id="has-start-time" type="button">has start time</button>
      <button class="relationship-button" id="has-end-date" type="button">has end date</button>
      <button class="relationship-button" id="has-end-place" type="button">has end place</button>
      <button class="relationship-button" id="has-end-time" type="button">has end time</button>
      <button class="relationship-button" id="has-event" type="button">has event</button>
      <button class="relationship-button" id="has-event-fact" type="button">has event fact</button>
      <button class="relationship-button" id="is-event-fact" type="button">is event fact</button>
      <button class="relationship-button" id="has-spouse" type="button">has spouse</button>
      <button class="relationship-button" id="has-father" type="button">has father</button>
      <button class="relationship-button" id="has-mother" type="button">has mother</button>
      <button class="relationship-button" id="age-of" type="button">age of</button>
      <button class="relationship-button" id="attended" type="button">attended</button>
      <button class="relationship-button" id="caused-by" type="button">caused by</button>
      <button class="relationship-button" id="contact-info" type="button">contact info</button>
      <button class="relationship-button" id="created" type="button">created</button>
      <button class="relationship-button" id="has-duration" type="button">has duration</button>
      <button class="relationship-button" id="employed-by" type="button">employed by</button>
      <button class="relationship-button" id="has-family-member" type="button">has family member</button>
      <button class="relationship-button" id="is-female" type="button">is female</button>
      <button class="relationship-button" id="is-fictional" type="button">is fictional</button>
      <button class="relationship-button" id="is-male" type="button">is male</button>
      <button class="relationship-button" id="is-member-of" type="button">is member of</button>
      <button class="relationship-button" id="name-combiner" type="button">name combiner</button>
      <button class="relationship-button" id="has-occupation" type="button">has occupation</button>
      <button class="relationship-button" id="owns" type="button">owns</button>
      <button class="relationship-button" id="precedes-recently" type="button">precedes recently</button>
      <button class="relationship-button" id="principals-associate" type="button">principal's associate</button>
      <button class="relationship-button" id="is-principal-person" type="button">is principal person</button>
      <button class="relationship-button" id="quantity" type="button">quantity</button>
      <button class="relationship-button" id="has-residence-place" type="button">has residence place</button>
      <button class="relationship-button" id="same-as" type="button">same as</button>
      <button class="relationship-button" id="is-subplace-of" type="button">is subplace of</button>
      <button class="relationship-button" id="has-title" type="button">has title</button>
    </div>
  </div>
</div>
  
<script type="text/javascript" src="resources/nbx-parse.js"></script>
<script type="text/javascript" src="resources/relation-types.js"></script>
<script type="text/javascript" src="resources/relation-validation-functions.js"></script>
<script src="resources/d3-v4-min.js"></script>
<!-- <script type="text/javascript" src="resources/relation-functions.js"></script> -->
<!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
<!-- <script src="http://marvl.infotech.monash.edu/webcola/cola.v3.min.js"></script> -->

<script>
  // Make a viewbox over the nbx text
function textVB() {
  var textDiv = document.getElementById("text-div");
  var vbWidth = textDiv.offsetWidth;
  var box = document.createElement("div");
  box.setAttribute("id", "text-viewbox");
  // box.setAttribute("position", "absolute");
  // box.setAttribute("border", "2px solid #000");
  box.style.width = (vbWidth - 15) + "px";
  box.style.height = "20%";
  box.style.top = "5%";
  box.style.left = "5px";
  box.style.pointerEvents = "none";
  document.getElementById("text-container").append(box);


}

function isOverlappedByViewBox(element) {
  var viewBoxElement = document.getElementById("text-viewbox");
  if (typeof viewBoxElement === "undefined" || viewBoxElement === null) {
    return false;
  }
  var viewBoxTop = viewBoxElement.getBoundingClientRect().top;
  var viewBoxBottom = viewBoxElement.getBoundingClientRect().bottom;
  var elementTop = element.getBoundingClientRect().top;
  var elementBottom = element.getBoundingClientRect().bottom;

  if (viewBoxTop <= elementTop && viewBoxBottom >= elementBottom) {
    return true;
  } else {
    return false;
  }
}
// get an array of elements in the nbx that are covered by the text-viewbox
function getCoveredElements() {
  var allElements = document.getElementsByTagName("span");
  var coveredElements = [];
  for (let element of allElements) {
    if (isOverlappedByViewBox(element)) {
      coveredElements.push(element);
    }
  }
  return coveredElements;
}

function rebuildDisplayedGraph() {
  var updatedEntities = [];
  for(element of getCoveredElements()) {
    var id = "#arrayindex" + element.id;
    updatedEntities.push(d3.select(".nodes").select(id)._groups[0][0].__data__);
  }
  var updatedRelations = [];
  for(relation of displayedGraph.relations) {
    if (updatedEntities.includes(relation.source) && updatedEntities.includes(relation.target)) {
      updatedRelations.push(relation);
    }
  }
  return [updatedEntities, updatedRelations];
}

function makeViewBoxResizeObserver() {
  var viewBoxResizeObserver = new ResizeObserver(entries => {
    displayedGraph.entities = rebuildDisplayedGraph()[0];
    displayedGraph.relations = rebuildDisplayedGraph()[1];
    restart();
  });
  viewBoxResizeObserver.observe(document.getElementById("text-viewbox"));
}



var simulation;
    // node,
    // link;
var displayedGraph,
    editedGraph,
    originalGraph,
    file;
var originalRelex,
    filename;

// -------------------------------EVENT LISTENERS-----------------------------------------
// ---------------------------------------------------------------------------------------
// -------------------------------TOP PANEL-----------------------------------------------
document.getElementById("file-intake-button").addEventListener("change", loadDocument);
document.getElementById("export").addEventListener("click", exportDocument);
// document.getElementById("toggle-same-as").addEventListener("click", showSameAsOn);
// document.getElementById("toggle-same-as").addEventListener("click", showSameAsOff);
document.getElementById("toggle-same-as").addEventListener("click", showSameAsButtonStyle);
document.getElementById("scissors").addEventListener("click", toggleScissors);
document.getElementById("reload-displayedGraph").addEventListener("click", loadWholeGraph);
document.getElementById("reload-displayedGraph").addEventListener("click", setShowSameAsButtonStyle);
document.getElementById("reload-displayedGraph").addEventListener("click", reloadDisplayedGraphToggleOn);
document.getElementById("reload-displayedGraph").addEventListener("click", relButtonStyleOff);
// document.getElementById("reload-displayedGraph").id = document.getElementById("reload-displayedGraph").id;
// -------------------------------RELATIONSHIP PANEL--------------------------------------
document.getElementById("has-start-date").addEventListener("click", hasStartDate);
document.getElementById("has-start-place").addEventListener("click", hasStartPlace);
document.getElementById("has-start-time").addEventListener("click", hasStartTime);
document.getElementById("has-end-date").addEventListener("click", hasEndDate);
document.getElementById("has-end-place").addEventListener("click", hasEndPlace);
document.getElementById("has-end-time").addEventListener("click", hasEndTime);
document.getElementById("has-event").addEventListener("click", hasEvent);
document.getElementById("has-event-fact").addEventListener("click", hasEventFact);
document.getElementById("is-event-fact").addEventListener("click", isEventFact);
document.getElementById("has-spouse").addEventListener("click", hasSpouse);
document.getElementById("has-father").addEventListener("click", hasFather);
document.getElementById("has-mother").addEventListener("click", hasMother);
document.getElementById("age-of").addEventListener("click", ageOf);
document.getElementById("attended").addEventListener("click", attended);
document.getElementById("caused-by").addEventListener("click", causedBy);
document.getElementById("contact-info").addEventListener("click", contactInfo);
document.getElementById("created").addEventListener("click", created);
document.getElementById("has-duration").addEventListener("click", hasDuration);
document.getElementById("employed-by").addEventListener("click", employedBy);
document.getElementById("has-family-member").addEventListener("click", hasFamilyMember);
document.getElementById("is-female").addEventListener("click", isFemale);
document.getElementById("is-fictional").addEventListener("click", isFictional);
document.getElementById("is-male").addEventListener("click", isMale);
document.getElementById("is-member-of").addEventListener("click", isMemberOf);
document.getElementById("name-combiner").addEventListener("click", nameCombiner);
document.getElementById("has-occupation").addEventListener("click", hasOccupation);
document.getElementById("owns").addEventListener("click", owns);
document.getElementById("precedes-recently").addEventListener("click", precedesRecently);
document.getElementById("principals-associate").addEventListener("click", principalsAssociate);
document.getElementById("is-principal-person").addEventListener("click", isPrincipalPerson);
document.getElementById("quantity").addEventListener("click", quantity);
document.getElementById("has-residence-place").addEventListener("click", hasResidencePlace);
document.getElementById("same-as").addEventListener("click", sameAs);
document.getElementById("is-subplace-of").addEventListener("click", subplaceOf);
document.getElementById("has-title").addEventListener("click", hasTitle);

var relationshipButtonClass = document.getElementsByClassName("relationship-button");
for (let i = 0; i < relationshipButtonClass.length; i++) {
  relationshipButtonClass[i].addEventListener("click", setShowSameAsButtonStyle);
  relationshipButtonClass[i].addEventListener("click", showSameAs);
  relationshipButtonClass[i].addEventListener("click", relButtonStyle);
  relationshipButtonClass[i].addEventListener("click", relButtonStyleOff);
  relationshipButtonClass[i].addEventListener("click", clearSelection);
  relationshipButtonClass[i].addEventListener("click", reloadDisplayedGraphToggleOff);
  // relationshipButtonClass[i].id = relationshipButtonClass[i].id;
}

function reloadDisplayedGraphToggleOn() {
  document.getElementById("reload-displayedGraph").style.border = "0px solid";
  document.getElementById("reload-displayedGraph").style.backgroundColor = "#40c702";
  document.getElementById("reload-displayedGraph").style.color = "#ffffff";
}
function reloadDisplayedGraphToggleOff() {
  document.getElementById("reload-displayedGraph").style.border = "none";
  document.getElementById("reload-displayedGraph").style.backgroundColor = "";
  document.getElementById("reload-displayedGraph").style.color = "";
}

function setShowSameAsButtonStyle() {
  if (getCurrentRelationship() != "R40:IS_SAME_AS" && getCurrentRelationship() != "UNSELECTED") {
    document.getElementById("toggle-same-as").style.display = "block";
  } else {
    document.getElementById("toggle-same-as").style.display = "none";
  }
}
function showSameAs() {
  // If we're already viewing "is same as" or all relations then we don't need to do anything - "UNSELECTED" means no relation filter
  if (showSameAsToggled()) {
    // console.log("Showing 'same as' links.");
    showSameAsOn();
  // } else if (!showSameAsToggled()) {
  //   // console.log("Hiding 'same as' links.");
  //   showSameAsOff();
  }
}
function showSameAsButtonStyle() {
  var element = document.querySelector("#toggle-same-as");
  var borderStyle = window.getComputedStyle(element).getPropertyValue("border-top-style");
  var backgroundColor = window.getComputedStyle(element).getPropertyValue("background-color");
  if (borderStyle == "solid") {
    // untoggle - make it default color
    // document.getElementById("toggle-same-as").style.backgroundColor = "rgb(243, 243, 243)";
    document.getElementById("toggle-same-as").style.border = "none";
    document.getElementById("toggle-same-as").style.backgroundColor = "";
    document.getElementById("toggle-same-as").style.color = "";
    showSameAsOff();
  // } else if (borderStyle == "none") {
  } else {
    // document.getElementById("toggle-same-as").style.backgroundColor = "rgb(204, 51, 51)";
    document.getElementById("toggle-same-as").style.border = "0px solid #cc3333";
    document.getElementById("toggle-same-as").style.backgroundColor = "#40c702";
    document.getElementById("toggle-same-as").style.color = "#ffffff";
    showSameAsOn();
  }
}
function showSameAsOn() {
  if (getCurrentRelationship() != "R40:IS_SAME_AS") {
    console.log("'Show Same As' button is toggled on");
    // used to determine if an entity from a same-as relationship in editedGraph.relations is in displayedGraph.entities
    function isADisplayedEntity(entity) {
      for (var i = 0; i < displayedGraph.entities.length; i++) {
        if (displayedGraph.entities[i].id == entity) {
          return true;
        }
      }
      return false;
    }
    editedGraph.getSameAsRels().forEach(function(relation) {
      if (isADisplayedEntity(relation.source) && isADisplayedEntity(relation.target)) {
// we can't push relations directly into displayedGraph, because then editedGraph objects get display elements tied to them.
// the displayedGraph and editedGraph need to remain separated in their roles. So we make a copy and push that.
        displayedGraph.relations.push({type : relation.type,
                                startToken : relation.startToken,
                                    source : relation.source,
                                  endToken : relation.endToken,
                                    target : relation.target,
                                  distance : linkDistance(relation.type)});
      }
    });
    sameAsRestart();
  }
}
function showSameAsOff() {
  if (getCurrentRelationship() != "R40:IS_SAME_AS") {
    console.log("'Show Same As' button is toggled off");
    for (var i = displayedGraph.relations.length - 1; i >= 0; i--) {
      if (displayedGraph.relations[i].type == "R40:IS_SAME_AS") {
        displayedGraph.relations.splice(i,1);
      }
    }
    restart();
  }
}
// is "show same as" button toggled
function showSameAsToggled() {
  var element = document.querySelector("#toggle-same-as");
  var borderStyle = window.getComputedStyle(element).getPropertyValue("border-top-style");
  if (borderStyle == "none") {
    return false;
  } else {
    return true;
  }
}

// make relation buttons appear "clicked"
function relButtonStyle(buttonId) {
  var buttonIdString = buttonId.target.id;
  var idSelector = "#" + buttonIdString;
  var element = document.querySelector(idSelector);
  var borderStyle = window.getComputedStyle(element).getPropertyValue("border-top-style");
  document.getElementById(buttonIdString).style.border = "0px solid #cc3333";
  document.getElementById(buttonIdString).style.backgroundColor = "#40c702";
  document.getElementById(buttonIdString).style.color = "#fefff0";
}
function relButtonStyleOff(buttonId) {
  var relationshipButtonClass = document.getElementsByClassName("relationship-button");
  var buttonIdString = buttonId.target.id;
  for (var i = 0; i < relationshipButtonClass.length; i++) {
    var relationId = relationshipButtonClass[i].id;
    if (relationId != buttonIdString) {
      document.getElementById(relationId).style.border = "none";
      document.getElementById(relationId).style.backgroundColor = "";
      document.getElementById(relationId).style.color = "";
    }
  }
}
//uploading a GedcomX
function loadDocument(event) {
  if (!event || !event.target || !event.target.files || event.target.files.length === 0) { alert("Try another file?"); }
  file = event.target.files[0];
  filename = file.name.replace(/\..+/, ".relex");
  d3.selectAll("g").remove();
  var reader = new FileReader();
  reader.onload = function(e) {
    const lastDot = file.name.lastIndexOf('.');
    const extension = file.name.substring(lastDot + 1);
    var content = e.target.result;
    if (extension == "json") {
      let obj = JSON.parse(content);
      // parsed = parseNbx((obj.records[0].documents[0].text).replace(/ \n/g, " ").replace(/\n/g, " "));
      var parsed = parseNbx((obj.records[0].documents[0].text));
      displayedGraph = buildAllData(parsed);
      editedGraph = buildAllData(parsed);
      originalGraph = buildAllData(parsed);
      var relex = obj.records[0].documents[0].text;
      originalRelex = relex;
      relex = convertTags(relex);
      document.getElementById("text-div").innerHTML = relex;
    }
    if (extension == "relex") {
      parsed = parseNbx(content);
      offsetChange(parsed);
      displayedGraph = buildAllData(parsed);
      editedGraph = buildAllData(parsed);
      originalGraph = buildAllData(parsed);
      originalRelex = content;
      var relex = convertTags(content);
      document.getElementById("text-div").innerHTML = relex;
    }
    colorizeText(getAllTypes());
    reloadDisplayedGraphToggleOn();
    window.setTimeout(startSimulation, 1200);
    enableTextToNodeHighlight();
  };
  reader.readAsText(file);
}
function exportDocument() {
  var originalNbx = originalRelex.replace(/<RELEX.+\n/g, "");
  var outputRelex = originalNbx;
  for (i = 0; i < editedGraph.relations.length; i++) {
    var rel = editedGraph.relations[i];
    var relString = "<RELEX TYPE=" + '"' + rel.type + '"'
                  + "_STID=" + '"' + rel.source + '"'
                  + "_ENDID=" + '"' + rel.target + '"'
                  + "_STTOKEN=" + '"' + rel.startToken + '"'
                  + "_ENDTOKEN=" + '"' + rel.endToken + '"' + ">";
    outputRelex += relString;
    if (i < editedGraph.relations.length - 1) {
      outputRelex += "\n";
    }
  }
  console.log("Output");
  console.log(outputRelex);
  var outfile = null;
  var makeFile = function(string) {
    var text = new Blob([string], {type: 'text/plain'});
    outfile = window.URL.createObjectURL(text);
    return outfile;
  };
  var link = document.createElement('a');
  link.setAttribute('download', filename);
  link.href = makeFile(outputRelex);
  document.body.appendChild(link);

  window.requestAnimationFrame(function () {
    var event = new MouseEvent('click');
    link.dispatchEvent(event);
    document.body.removeChild(link);
  });
}
// offsetChange is for processing (some?) relex that have gone through PATMAT before. The offsets are different because
// of newlines getting changed to spaces
function offsetChange(parsedRelex) {
  for (i in parsedRelex.metadata) {
    var entity = parsedRelex.metadata[i].content;
    for (j in entity) {
      if (entity[j].tag == "ENAMEX" || entity[j].tag == "TIMEX" || entity[j].tag == "NUMEX") {
        entity[j].offset = (entity[j].offset) + 5;
      }
    }
  }
  for (i in parsedRelex.sbody) {
    var entity = parsedRelex.sbody[i];
    //console.log(entity);
    if (entity.tag == "ENAMEX" || entity.tag == "TIMEX" || entity.tag == "NUMEX") {
      entity.offset = (entity.offset) + 6;
    }
  }
}

//---------------------------------Node/Link Interactions------------------------------
function toggleScissors() {
  var element = document.querySelector("#svg-container");
  var cursorStyle = window.getComputedStyle(element).getPropertyValue("cursor");
  // console.log(cursorStyle);
  if (cursorStyle == "auto") {
    document.getElementById("svg-container").style.cursor = 'url("resources/scissor.png") 15 15, auto';
    // document.getElementById("scissors").style.border = "2px solid #cc3333";
    document.getElementById("scissors").style.backgroundColor = "#40c702";
    document.getElementById("scissors").style.color = "#ffffff";
    // console.log("Set to scissors");
  } else {
    document.getElementById("svg-container").style.cursor = "auto";
    // document.getElementById("scissors").style.border = "none";
    document.getElementById("scissors").style.backgroundColor = "";
    document.getElementById("scissors").style.color = "";
    // console.log("Set to default");
  }
}
function scissorsToggled() {
  var element = document.querySelector("#svg-container");
  var cursorStyle = window.getComputedStyle(element).getPropertyValue("cursor");
  if (cursorStyle == "auto") {
    return false;
  } else if (cursorStyle == "crosshair") {
    return false;
  } else {
    return true;
  }
}
function linkMouseOver(d) {
  if (scissorsToggled()) {
    d3.select(this)
      .style("stroke-width", 6)
      // .attr("markerWidth",1)  //These two determine arrowhead size
      // .attr("markerHeight",1)
      // .attr("refX",14)    //arrow placement:how far it is from node center
      .style("stroke", "red");
  }
}
function linkMouseOut(d) {
  if (scissorsToggled()) {
    d3.select(this)
      // .attr("markerWidth",3)  //These two determine arrowhead size
      // .attr("markerHeight",4)
      .style("stroke", "black")
      .style("stroke-width", 4);
  }
}
function linkCut(d) {
  if (scissorsToggled()) {
    // console.log(d);
    let toCutIndex = displayedGraph.relations.findIndex( function(element) {
      return element == d;
    });
    console.log("Cutting at index: " + toCutIndex);
    displayedGraph.relations.splice(toCutIndex,1);
    restart();
    // now remove it from editedGraph
    // toCutIndex = editedGraph.relations.findIndex( function(element) {
    //   return element == d;
    // });
    editedGraph.relations.splice(toCutIndex,1);
    // console.log(displayedGraph);
    // console.log(editedGraph);
  }
}
  // textEntities refers to the tagged entities in the nbx
function enableTextToNodeHighlight() {
  let textEntities = document.getElementsByTagName("span");
  for (let i = 0; i < textEntities.length; i++) {
    textEntities[i].addEventListener("click", function(mouseEventObj) {
      // d3.select("#arrayindex"+mouseEventObj.srcElement.id).select("circle")
      //     .attr("stroke", "#ff0000")
      //     .transition().attr("stroke-width", "4px")
      //     .attr("r", getNodeDefaultRadius() * .7);
      let entityID = mouseEventObj.srcElement.id;
      let entity = displayedGraph.entities.find(function(e) {
        return e.arrayindex == entityID;
      });
      nodeClick(entity);
    });
    textEntities[i].addEventListener("dblclick", function(mouseEventObj) {
      let entityID = mouseEventObj.srcElement.id;
      let entity = displayedGraph.entities.find(function(e) {
        return e.arrayindex == entityID;
      });
      nodeDoubleClick(entity);
    });
    textEntities[i].addEventListener("mouseover", function(mouseEventObj) {
      let id = "#arrayindex" + mouseEventObj.srcElement.id;
      // document.getElementById(id).getElementsByTagName("circle")[0]
      d3.select(".nodes").select(id).select("circle")
          .transition().attr("r", getNodeDefaultRadius() * 1.2)
          .attr("stroke", "#000000")
          .transition().attr("stroke-width","4px");
    });
    textEntities[i].addEventListener("mouseout", function(mouseEventObj) {
      // if it's a selected node, we need to leave it in that state when mouseout
      // current behavior - if I select a node, then mouseover and mouseout on other nodes,
      // they stay big with a black border
      // If I select a node, and hover over it, it stays black and bold.
      // So both of these are caused by the same problem.
      // I need to:
      // if something is selected, it's previous state must be preserved
      // -- selected stays small and red border
      // -- normal goes back to normal
      // So when mouseout-ing each node, I need to check if it is in selectedNodeElements.
      let DOMelement = document.getElementById("arrayindex" + mouseEventObj.srcElement.id);
      if (selectedNodeElements.includes(DOMelement)) {
        d3.select(DOMelement).select("circle")
        .transition()
        .attr("stroke", "#ff0000")
        .attr("stroke-width", "4px")
        .attr('r', getNodeDefaultRadius() * .7);
      } else {
        let id = "#arrayindex" + mouseEventObj.srcElement.id;
        d3.select(".nodes").select(id).select("circle")
            .transition().attr("r", getNodeDefaultRadius())
            .transition().attr("stroke-width","2px")
            .attr("stroke", "#dfdfdf");
      }
    });
  };
}
var nbxHighlight = function(d) {
  let currentStyleBGColor = document.getElementById(d.arrayindex).style.backgroundColor;
  let currentStyleColor = document.getElementById(d.arrayindex).style.color;
  let obj = {
    highlight() {
      let element = document.getElementById(d.arrayindex);
      element.style.fontWeight = "900";
      element.style.border = "3px solid #000000";
      element.style.backgroundColor = "#ffff00";
      element.style.color = "black";
      element.scrollIntoView({behavior: "smooth", block: "center"});
    },
    unhighlight() {
      let element = document.getElementById(d.arrayindex);
      element.style.fontWeight = "normal";
      element.style.border = "none";
      applyStyle(element);
    }
  };
  return obj;
}
var hover = false;
function nodeMouseOver(d) {
  // console.log("Hovering over " + d.text);
  if (!scissorsToggled()) {
    document.getElementById("svg-container").style.cursor = "crosshair";
  }
  nbxHighlight(d).highlight();
  hover = true;
}
function nodeMouseOut(d) {
  // console.log("Left node " + d.text);
  if (!scissorsToggled()) {
    document.getElementById("svg-container").style.cursor = "auto";
  }
  if (!selectedNodes.includes(d)) {
    nbxHighlight(d).unhighlight();
  }
  hover = false;
}
// double-click a node after making a selection of nodes to create a link between the selected, and the target.
function nodeDoubleClick(d) {
  console.log("Double-clicked node " + d.text);
  // console.log(selectedNodes);
  // if ctrl key not pressed and nodes are selected, make links [selected ndoes]->(clicked node)
  if (selectedNodes.length > 0) {
    for (i in selectedNodes) {
      var targetNode = d;
      displayedGraph.relations.push({type : getCurrentRelationship(),
                      startToken : selectedNodes[i].text,
                          source : selectedNodes[i].id,
                        endToken : targetNode.text,
                          target : targetNode.id,
                        distance : linkDistance(getCurrentRelationship())});
      console.log("Added link between " + selectedNodes[i].text + " and " + targetNode.text);
      editedGraph.relations.push({type : getCurrentRelationship(),
                      startToken : selectedNodes[i].text,
                          source : selectedNodes[i].id,
                        endToken : targetNode.text,
                          target : targetNode.id,
                        distance : linkDistance(getCurrentRelationship())});
    }
    clearSelection();
    restart();
  }
}
// these are relation sources
var selectedNodes = [];
// these are the visible dots on the screen
var selectedNodeElements = [];
// ctrl-click a node to make a selection. Multiple nodes may be selected for linking to a single target.
function nodeClick(d) {
  // if ctrl key pressed down
  // add clicked node as relation source
  if (getCurrentRelationship() != "UNSELECTED") {
    let DOMelement = document.getElementById("arrayindex"+d.arrayindex);
    if (selectedNodes.includes(d)) {
      selectedNodes.splice(selectedNodes.indexOf(d),1);
      d3.select(selectedNodeElements[selectedNodeElements.indexOf(DOMelement)]).select("circle")
      .transition()
      .attr('r', getNodeDefaultRadius())
      .attr("stroke", "#dfdfdf")
      .attr("stroke-width", "2px")
      .attr("fill", function(d) {return colors(d.type);});
      selectedNodeElements.splice(selectedNodeElements.indexOf(DOMelement),1);
      nbxHighlight(d).unhighlight();
      console.log("Node unselected");
    } else {
      nbxHighlight(d).highlight();
      d3.select(DOMelement).select("circle")
        .transition()
        .attr("stroke", "#ff0000")
        .attr("stroke-width", "4px")
        .attr('r', getNodeDefaultRadius() * .7);
      selectedNodes.push(d);
      selectedNodeElements.push(DOMelement);
      console.log("Node selected");
    }
  } else if (getCurrentRelationship() == "UNSELECTED") {
    alert("Please select a relationship type first.");
  }
}
function clearSelection() {
  // check if none are selected at all so that clicks on empty space don't trigger this function
  if (selectedNodes.length != 0) {
    for (i in selectedNodeElements) {
      // console.log(selectedNodes[i]);
      d3.select(selectedNodeElements[i]).select("circle")
        .transition()
        .attr('r', getNodeDefaultRadius())
        .attr("stroke", "#dfdfdf")
        .attr("stroke-width", "2px")
        .attr("fill", function(d) {return colors(d.type);});
    }
    for (i in selectedNodes) {
      nbxHighlight(selectedNodes[i]).unhighlight();
    }
    selectedNodes = [];
    selectedNodeElements = [];
    console.log("Selected nodes cleared.");
  }
}
function onClick() {
  if (!hover) {
    // // if ctrl not pressed and click is on empty space
    // for (i in selectedNodeElements) {
    //     // console.log(selectedNodes[i]);
    //     d3.select(selectedNodeElements[i]).select("circle")
    //       .transition()
    //       .attr('r', radius);
    //   }
    //   selectedNodes = [];
    //   selectedNodeElements = [];
    //   console.log("Selected nodes cleared.");
    clearSelection();
  }
  if (hover) {
    console.log("hovering over a node");
  }
}

function ctrlKeydown(d) {
  if (d3.event.ctrlKey) {
    console.log("CTRL key pressed.");
    document.getElementById("svg-container").style.cursor = "crosshair";
  }
}
function ctrlKeyup(d) {
  if (!d3.event.ctrlKey) {
    console.log("CTRL key released.");
    document.getElementById("svg-container").style.cursor = "auto";
  }
}

// If the relationship isn't valid, hide the relationship button. This means that the entities required to make the relation don't exist. (Principal persons, but no people entities)
function relationValidator() {
  // if there are no events and no persons, or there are no dates, invalid
  // for (i = 0; i < originalGraph.relations.length; i++) {

  // }
}

function getSimulationDisplaySpaceDimensions() {
  var width = window.getComputedStyle(document.querySelector("#svg-container")).getPropertyValue("width").replace(/\..+/, ""),
    height = window.getComputedStyle(document.querySelector("#svg-container")).getPropertyValue("height").replace(/\..+/, "");
  return [width, height];
}
function getNodeDefaultRadius() {
  return 30; // 30
}
function convertTags(relex) {
  // we replace with "<-span..." because we need to go through after one at a time and
  // add a unique id according to the order the enamex shows up in the text. This is so
  // that we can have text highlighting when a node is hovered over.
  relex = relex
          .replace(/<ENAMEX TYPE="STRUCTURE.addr">/g, "<-span class='ENAMEX STRUCTURE_addr'>")
          .replace(/<ENAMEX TYPE="AGE">/g, "<-span class='ENAMEX AGE'>")
          .replace(/<ENAMEX TYPE="ANIMAL">/g, "<-span class='ENAMEX ANIMAL'>")
          .replace(/<ENAMEX TYPE="CHEMICAL">/g, "<-span class='ENAMEX CHEMICAL'>")
          .replace(/<ENAMEX TYPE="DURATANNIV">/g, "<-span class='ENAMEX DURATANNIV'>")
          .replace(/<ENAMEX TYPE="COREF.gen">/g, "<-span class='ENAMEX COREF_gen'>")
          .replace(/<ENAMEX TYPE="COREF.loc">/g, "<-span class='ENAMEX COREF_loc'>")
          .replace(/<TIMEX TYPE="COREF.dat">/g, "<-span class='TIMEX COREF_dat'>")
          .replace(/<ENAMEX TYPE="COREF">/g, "<-span class='ENAMEX COREF'>")
          .replace(/<TIMEX TYPE="DATE">/g, "<-span class='TIMEX DATE'>")
          .replace(/<TIMEX TYPE="DATE.non">/g, "<-span class='TIMEX DATE_non'>")
          .replace(/<ENAMEX TYPE="EVENT">/g, "<-span class='ENAMEX EVENT'>")
          .replace(/<ENAMEX TYPE="EVENT.rel">/g, "<-span class='ENAMEX EVENT_rel'>")
          .replace(/<ENAMEX TYPE="EVENT.xlife">/g, "<-span class='ENAMEX EVENT_xlife'>")
          .replace(/<ENAMEX TYPE="FAMILYMEMBER">/g, "<-span class='ENAMEX FAMILYMEMBER'>")
          .replace(/<ENAMEX TYPE="NONFAMILY">/g, "<-span class='ENAMEX NONFAMILY'>")
          .replace(/<ENAMEX TYPE="FOOD_DRINK">/g, "<-span class='ENAMEX FOOD_DRINK'>")
          .replace(/<ENAMEX TYPE="GAME">/g, "<-span class='ENAMEX GAME'>")
          .replace(/<ENAMEX TYPE="HEALTH_CONDITION">/g, "<-span class='ENAMEX HEALTH_CONDITION'>")
          .replace(/<ENAMEX TYPE="LOCALE">/g, "<-span class='ENAMEX LOCALE'>")
          .replace(/<ENAMEX TYPE="LOCALE.notgpe">/g, "<-span class='ENAMEX LOCALE_notgpe'>")
          .replace(/<ENAMEX TYPE="ITE.gpe">/g, "<-span class='ENAMEX ITE_gpe'>")
          .replace(/<ENAMEX TYPE="ITE.notgpe">/g, "<-span class='ENAMEX ITE_notgpe'>")
          .replace(/<ENAMEX TYPE="ITE.org">/g, "<-span class='ENAMEX ITE_org'>")
          .replace(/<ENAMEX TYPE="STRUCTURE">/g, "<-span class='ENAMEX STRUCTURE'>")
          .replace(/<NUMEX TYPE="MONEY">/g, "<-span class='NUMEX MONEY'>")
          .replace(/<ENAMEX TYPE="OCCUPATION">/g, "<-span class='ENAMEX OCCUPATION'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION">/g, "<-span class='ENAMEX ORGANIZATION'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.edu">/g, "<-span class='ENAMEX ORGANIZATION_edu'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.mil">/g, "<-span class='ENAMEX ORGANIZATION_mil'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.music">/g, "<-span class='ENAMEX ORGANIZATION_music'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.pub">/g, "<-span class='ENAMEX ORGANIZATION_pub'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.rel">/g, "<-span class='ENAMEX ORGANIZATION_rel'>")
          .replace(/<ENAMEX TYPE="ORGANIZATION.sports">/g, "<-span class='ENAMEX ORGANIZATION_sports'>")
          .replace(/<ENAMEX TYPE="ETPLACE">/g, "<-span class='ENAMEX ETPLACE'>")
          .replace(/<NUMEX TYPE="PERCENT">/g, "<-span class='NUMEX PERCENT'>")
          .replace(/<ENAMEX TYPE="PERSON">/g, "<-span class='ENAMEX PERSON'>")
          .replace(/<ENAMEX TYPE="PHONENUMBER">/g, "<-span class='ENAMEX PHONENUMBER'>")
          .replace(/<ENAMEX TYPE="FLORA">/g, "<-span class='ENAMEX FLORA'>")
          .replace(/<NUMEX TYPE="QUANTITY">/g, "<-span class='NUMEX QUANTITY'>")
          .replace(/<TIMEX TYPE="TIME">/g, "<-span class='TIMEX TIME'>")
          .replace(/<ENAMEX TYPE="TITLE">/g, "<-span class='ENAMEX TITLE'>")
          .replace(/<ENAMEX TYPE="TITLEFPH">/g, "<-span class='ENAMEX TITLEFPH'>")
          .replace(/<ENAMEX TYPE="VEHICLE">/g, "<-span class='ENAMEX VEHICLE'>")
          .replace(/<ENAMEX TYPE="WEAPON">/g, "<-span class='ENAMEX WEAPON'>")
          .replace(/<ENAMEX TYPE="URL">/g, "<-span class='ENAMEX URL'>")
          .replace(/<ENAMEX TYPE="WORK_OF_ART">/g, "<-span class='ENAMEX WORK_OF_ART'>")
          .replace(/<\/ENAMEX>/g, "</span>")
          .replace(/<\/TIMEX>/g, "</span>")
          .replace(/<\/NUMEX>/g, "</span>");

  for (let i = 0; i < originalGraph.entities.length; i++) {
    var replacementString = "<span id='" + i + "'";
    // var included = relex.includes("<span");
    relex = relex.replace("<-span", replacementString);
  }
  return relex;
}
function toClassStyle(type) {
  let classStyle = type.replace(/\./g, "_");
  classStyle = "." + classStyle;
  return classStyle;
}
function convertEntityTags(relex) {
  for (type of getAllTypes()) {
    let replacing = '<ENAMEX TYPE="' + type + '">';
    let replacement = "<-span class='ENAMEX " + toClassStyle(type) + "'>";
    relex.replace(/replacing/g, replacement);
  }
}
// need to convert list of types to css format
// 1. change . to _
// 2. prepend .
function toCssClass(typesArray) {
  var types = [];
  typesArray.forEach(function(type) {
    let cssClass = type.replace(/\./g, "_");
    cssClass = "." + cssClass;
    types.push(cssClass);
  });
  return types;
}
function applyStyle(element) {
  if (element.className == "ENAMEX STRUCTURE_addr") {
    element.style.backgroundColor = "#999900";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX AGE") {
    element.style.backgroundColor = "#669AC4";
  } else if (element.className == "ENAMEX ANIMAL") {
    element.style.backgroundColor = "#80771F";
    element.style.backgroundColor = "#ffffff";
  } else if (element.className == "ENAMEX CHEMICAL") {
    element.style.backgroundColor = "#AAFF0D";
  } else if (element.className == "ENAMEX DURATANNIV") {
    element.style.backgroundColor = "#1E90FF";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX COREF_gen") {
    element.style.backgroundColor = "#E5CCFF";
  } else if (element.className == "ENAMEX COREF_loc") {
    element.style.backgroundColor = "#6a5abd";
    element.style.color = "#ffffff";
  } else if (element.className == "TIMEX COREF_dat") {
    element.style.backgroundColor = "#089977";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX COREF") {
    element.style.backgroundColor = "#7b68ee";
    element.style.color = "#ffffff";
  } else if (element.className == "TIMEX DATE") {
    element.style.backgroundColor = "#0400ff";
    element.style.color = "#ffffff";
  } else if (element.className == "TIMEX DATE_non") {
    element.style.backgroundColor = "#20b2aa";
  } else if (element.className == "ENAMEX EVENT") {
    element.style.backgroundColor = "#00ff51";
  } else if (element.className == "ENAMEX EVENT_rel") {
    element.style.backgroundColor = "#99ff99";
  } else if (element.className == "ENAMEX EVENT_xlife") {
    element.style.backgroundColor = "#ccffcc";
  } else if (element.className == "ENAMEX FAMILYMEMBER") {
    element.style.backgroundColor = "#ee6a69";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX NONFAMILY") {
    element.style.backgroundColor = "#f5deb3";
  } else if (element.className == "ENAMEX FOOD_DRINK") {
    element.style.backgroundColor = "#ff35cc";
  } else if (element.className == "ENAMEX GAME") {
    element.style.backgroundColor = "#99004c";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX HEALTH_CONDITION") {
    element.style.backgroundColor = "#cedcba";
  } else if (element.className == "ENAMEX LOCALE") {
    element.style.backgroundColor = "#9c6927";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX LOCALE_notgpe") {
    element.style.backgroundColor = "#e65ecd";
  } else if (element.className == "ENAMEX ITE_gpe") {
    element.style.backgroundColor = "#ff00d0";
  } else if (element.className == "ENAMEX ITE_notgpe") {
    element.style.backgroundColor = "#e65ecd";
  } else if (element.className == "ENAMEX ITE_org") {
    element.style.backgroundColor = "#eb9ddc";
  } else if (element.className == "ENAMEX STRUCTURE") {
    element.style.backgroundColor = "#ffbe0d";
  } else if (element.className == "NUMEX MONEY") {
    element.style.backgroundColor = "#fedcba";
  } else if (element.className == "ENAMEX OCCUPATION") {
    element.style.backgroundColor = "#ff6a00";
  } else if (element.className == "ENAMEX ORGANIZATION") {
    element.style.backgroundColor = "#cc0000";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX ORGANIZATION_edu") {
    element.style.backgroundColor = "#ff2638";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX ORGANIZATION_mil") {
    element.style.backgroundColor = "#94323a";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX ORGANIZATION_music") {
    element.style.backgroundColor = "#fad9dc";
  } else if (element.className == "ENAMEX ORGANIZATION_pub") {
    element.style.backgroundColor = "#c36276";
  } else if (element.className == "ENAMEX ORGANIZATION_rel") {
    element.style.backgroundColor = "#ed8089";
  } else if (element.className == "ENAMEX ORGANIZATION_sports") {
    element.style.backgroundColor = "#e34451";
  } else if (element.className == "ENAMEX ETPLACE") {
    element.style.backgroundColor = "#bfbfbf";
  } else if (element.className == "NUMEX PERCENT") {
    element.style.backgroundColor = "#005e7d";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX PERSON") {
    element.style.backgroundColor = "#3f9c05";
  } else if (element.className == "ENAMEX PHONENUMBER") {
    element.style.backgroundColor = "#a9a9a9";
  } else if (element.className == "ENAMEX FLORA") {
    element.style.backgroundColor = "#abcdef";
  } else if (element.className == "NUMEX QUANTITY") {
    element.style.backgroundColor = "#66b2ff";
  } else if (element.className == "TIMEX TIME") {
    element.style.backgroundColor = "#6686c4";
  } else if (element.className == "ENAMEX TITLE") {
    element.style.backgroundColor = "#ffa266";
  } else if (element.className == "ENAMEX TITLEFPH") {
    element.style.backgroundColor = "#ffc266";
  } else if (element.className == "ENAMEX VEHICLE") {
    element.style.backgroundColor = "#8e44fc";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX WEAPON") {
    element.style.backgroundColor = "#6600ff";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX URL") {
    element.style.backgroundColor = "#606060";
    element.style.color = "#ffffff";
  } else if (element.className == "ENAMEX WORK_OF_ART") {
    element.style.backgroundColor = "#ffff4d";
  }
}
// color the nbx text, only entities relevant to the selected relationship are colored
function colorizeText(validTypes) {
  var colorElements = document.querySelectorAll(toCssClass(validTypes).join(","));
  var allElements = document.querySelectorAll(".ENAMEX, .TIMEX, .NUMEX");
  function includes(collection, item) {
    for (thing of collection) {
      if (thing == item) {
        return true;
      }
    }
    return false;
  }
  allElements.forEach(function(element) {
    if (includes(colorElements, element)) {
      applyStyle(element);
    } else {
      element.style.backgroundColor = null;
      element.style.color = null;
    }
  });
}

// for coloring text that sits on nodes
function textColors(type) {
  if (type == "STRUCTURE.addr") {return "#ffffff"}
  else if (type == "AGE") { return "#000000"}
  else if (type == "ANIMAL") { return "#ffffff"}
  else if (type == "CHEMICAL") { return "#000000"}
  else if (type == "COREF.gen") { return "#000000"}
  else if (type == "COREF.loc") { return "#ffffff"}
  else if (type == "COREF.dat") { return "#ffffff"}
  else if (type == "COREF") { return "#ffffff"}
  else if (type == "DATE") { return "#ffffff"}
  else if (type == "DATE.non") { return "#000000"}
  else if (type == "DURATANNIV") { return "#ffffff"}
  else if (type == "EVENT") { return "#000000"}
  else if (type == "EVENT.rel") { return "#000000"}
  else if (type == "EVENT.xlife") { return "#000000"}
  else if (type == "ITE.et") { return "#000000"}
  else if (type == "FAMILYMEMBER") { return "#ffffff"}
  else if (type == "NONFAMILY") { return "#000000"}
  else if (type == "FOOD_DRINK") { return "#000000"}
  else if (type == "GAME") { return "#ffffff"}
  else if (type == "HEALTH_CONDITION") { return "#000000"}
  else if (type == "ITE.gpe") { return "#000000"}
  else if (type == "ITE.notgpe") { return "#000000"}
  else if (type == "ITE.org") { return "#000000"}
  else if (type == "LOCALE") { return "#ffffff"}
  else if (type == "LOCALE.notgpe") { return "#000000"}
  else if (type == "STRUCTURE") { return "#000000"}
  else if (type == "MONEY") { return "#000000"}
  else if (type == "OCCUPATION") { return "#000000"}
  else if (type == "ORGANIZATION") { return "#ffffff"}
  else if (type == "ORGANIZATION.edu") { return "#ffffff"}
  else if (type == "ORGANIZATION.mil") { return "#ffffff"}
  else if (type == "ORGANIZATION.music") { return "#000000"}
  else if (type == "ORGANIZATION.pub") { return "#000000"}
  else if (type == "ORGANIZATION.rel") { return "#000000"}
  else if (type == "ORGANIZATION.sports") { return "#000000"}
  else if (type == "ETPLACE") { return "#000000"}
  else if (type == "PERCENT") { return "#ffffff"}
  else if (type == "PERSON") { return "#000000"}
  else if (type == "PHONENUMBER") { return "#000000"}
  else if (type == "FLORA") { return "#000000"}
  else if (type == "QUANTITY") { return "#000000"}
  else if (type == "TIME") { return "#000000"}
  else if (type == "TITLE") { return "#000000"}
  else if (type == "TITLEFPH") { return "#000000"}
  else if (type == "VEHICLE") { return "#ffffff"}
  else if (type == "WEAPON") { return "#ffffff"}
  else if (type == "URL") { return "#ffffff"}
  else if (type == "WORK_OF_ART") { return "#000000"}
  else { return "#ff69b4" }
}
// for coloring nodes according to enamex type
function colors(type) {
  if (type == "STRUCTURE.addr") {return "#999000"}
  else if (type == "AGE") { return "#669ac4"}
  else if (type == "ANIMAL") { return "#80771f"}
  else if (type == "CHEMICAL") { return "#aaff0d"}
  else if (type == "COREF.gen") { return "#e5ccff"}
  else if (type == "COREF.loc") { return "#6a5abd"}
  else if (type == "COREF.dat") { return "#089977"}
  else if (type == "COREF") { return "#7b68ee"}
  else if (type == "DATE") { return "#0400ff"}
  else if (type == "DATE.non") { return "#20b2aa"}
  else if (type == "DURATANNIV") { return "#1e90ff"}
  else if (type == "EVENT") { return "#00ff51"}
  else if (type == "EVENT.rel") { return "#99ff99"}
  else if (type == "EVENT.xlife") { return "#ccffcc"}
  else if (type == "ITE.et") { return "#e6cce2"}
  else if (type == "FAMILYMEMBER") { return "#ee6a69"}
  else if (type == "NONFAMILY") { return "#f5deb3"}
  else if (type == "FOOD_DRINK") { return "#ffe5cc"}
  else if (type == "GAME") { return "#99004c"}
  else if (type == "HEALTH_CONDITION") { return "#cedcba"}
  else if (type == "ITE.gpe") { return "#ff00d0"}
  else if (type == "ITE.notgpe") { return "#e65ecd"}
  else if (type == "ITE.org") { return "#eb9ddc"}
  else if (type == "LOCALE") { return "#9c6927"}
  else if (type == "LOCALE.notgpe") { return "#cfaf59"}
  else if (type == "STRUCTURE") { return "#ffbe0d"}
  else if (type == "MONEY") { return "#fedcba"}
  else if (type == "OCCUPATION") { return "#ff6a00"}
  else if (type == "ORGANIZATION") { return "#cc0000"}
  else if (type == "ORGANIZATION.edu") { return "#ff2638"}
  else if (type == "ORGANIZATION.mil") { return "#94323a"}
  else if (type == "ORGANIZATION.music") { return "#fad9dc"}
  else if (type == "ORGANIZATION.pub") { return "#c36276"}
  else if (type == "ORGANIZATION.rel") { return "#ed8089"}
  else if (type == "ORGANIZATION.sports") { return "#e34451"}
  else if (type == "ETPLACE") { return "#bfbfbf"}
  else if (type == "PERCENT") { return "#005e7d"}
  else if (type == "PERSON") { return "#3f9c05"}
  else if (type == "PHONENUMBER") { return "#a9a9a9"}
  else if (type == "FLORA") { return "#abcdef"}
  else if (type == "QUANTITY") { return "#66b2ff"}
  else if (type == "TIME") { return "#6686c4"}
  else if (type == "TITLE") { return "#ffa266"}
  else if (type == "TITLEFPH") { return "#ffc266"}
  else if (type == "VEHICLE") { return "#8e44fc"}
  else if (type == "WEAPON") { return "#6600ff"}
  else if (type == "URL") { return "#606060"}
  else if (type == "WORK_OF_ART") { return "#fafa02"}
  else { return "#ff69b4" }
}
// Adjusts forceManyBody strength according to number of nodes displayed to fit them into the view window
function getChargeForceStrength(nodeQuantity) {
  return -Math.exp(-(nodeQuantity - 100)/19) - 12;
}
// for setting link distance based on relationship type
function linkDistance(type) {
  if (type == "R40:IS_SAME_AS") {
    return 70;
  } else {
    return 130;
  }
}
function getNodeTextPlacement(text) {
  // [x position, y position]
  // return [Math.log(text.length) / Math.log(1.5) * -3.2, 4];
  return [Math.log(text.length) / Math.log(.88) * 1, 4];
}
function groupPath(d) {
    if (d.length === 2) {
      var arr = d.map(function(i) {
        return [i.x, i.y];
      });
      arr.push([arr[0][0], arr[0][1]]);
      return "M" + d3.polygonHull(arr).join("L") + "Z";
    } else {
      return "M" + d3.polygonHull(d.map(function(entity) {
        return [entity.x, entity.y];
      })).join("L") + "Z";
    }
  };
//-------------------------------------D3 Simulation-----------------------------------------
function startSimulation() {
  //create somewhere to put the force directed displayedGraph
  var width = getSimulationDisplaySpaceDimensions()[0],
    height = getSimulationDisplaySpaceDimensions()[1],
    radius = getNodeDefaultRadius();
  svg = d3.select("svg")
    .style("width", width + 'px')
    .style("height", height + 'px');
  
  d3.select("svg")
    .on("keydown", ctrlKeydown)
    .on("keyup", ctrlKeyup)
    .on("click", onClick);
  //add arrow styling to links
  svg.append("svg:defs").selectAll("marker")
    .data(["arrowhead"])    //different link types defined here
    .enter().append("svg:marker")   //section adds the arrows
    .attr("id", String) //without this no arrows show up
    .attr("viewBox","0 -5 10 10")   //this cuts off the arrow image - you could use this to show half an arrow
    .attr("refX",28)    //arrow placement:how far it is from node center
    .attr("refY",0)     //arrow placement:offset from center line of node
    .attr("markerWidth",8)  //These two determine arrowhead size
    .attr("markerHeight",4)
    .attr("orient","auto")  //this makes arrowheads aline with link lines
    .append("svg:path") //svg path attributes - https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths
    .attr("d", "M 0,-5 L 10,0 L 0,5");

  var hulls = svg.append("g")
                  .attr("class", "hull")
                .selectAll("path");
  //draw links
  var link = svg.append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(displayedGraph.relations)
    .enter().append("line")
    .attr('marker-end','url(#arrowhead)')
    .style("stroke-width", 4)
    .style("stroke", "black")
    // .style("stroke-width", function(d) {return Math.sqrt(d.value);}) //makes all arrows same size
    .on("mouseover", linkMouseOver)
    .on("mouseout", linkMouseOut)
    .on("click", linkCut);
  
  //draw nodes
  var node = svg.append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(displayedGraph.entities)
    .enter().append("g")
    .on("mouseover", nodeMouseOver)
    .on("mouseout", nodeMouseOut)
    .on("click", nodeClick)
    .on("dblclick", nodeDoubleClick);
  
  //   var m = displayedGraph.entities.length;
  // node._groups[0].forEach(function(d, i) {
  //   d.x=Math.cos(i/m*2*Math.PI) * 200 + width/2 + Math.random();
  //   d.y=Math.sin(i/m*2*Math.PI) * 200 + height/2 + Math.random();
  // });
  let m = displayedGraph.entities.length;
  displayedGraph.entities.forEach(function(d) {
    d.x = width/2 + Math.cos(Math.random() * 2*Math.PI) * Math.random() * 300;
    d.y = height/2 + Math.sin(Math.random() * 2*Math.PI) * Math.random() * 300;
  });

  // node.attr("transform", function(d) {
  //   return "translate("
  //       + Math.max(radius, Math.min(width - radius, d.x))
  //       + ", "
  //       + Math.max(radius, Math.min(height - radius, d.y))
  //       + ")";
  // });

  node.call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended));
  node.attr("id", function(d) {return "arrayindex" + d.arrayindex;})
      .attr("arrayindex", function(d) {return d.arrayindex;});
  //draw circles for nodes
  node.append("circle")
      .attr("stroke", "#dfdfdf")
      .attr("stroke-width", "2px")
      .attr("r", 0).transition().attr("r", radius)
      .attr("fill", function(d) {return colors(d.type);});

  node.append("svg:title")
      .text(function(d) { return d.text; });
  //show text labels next to nodes
  node.append("text")
      .text(function(d) {
        if (d.text.length > 6) {
          return d.text.substr(0,5) + "...";
        } else {
          return d.text;
        }
      })
      .style("fill", function(d) {return textColors(d.type);})
      .attr("x", function(d) {return getNodeTextPlacement(d.text)[0];})
      .attr("y", function(d) {return getNodeTextPlacement(d.text)[1];});

  // console.log(displayedGraph.entities.length);
  // console.log("width: " + width);
  // console.log("height: " + height);
  //set up the simulation
  simulation = d3.forceSimulation()
    // .force("link", d3.forceLink().id(function(d) {return d.id;}))
    .force("link", d3.forceLink(link).id(function(d) {return d.id;}).distance(function(d) {return d.distance}))
    // .distance( linkDistance(function(d) {return d.type;}) ).strength(1)
    // .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(75).strength(.9))
    .force("charge-force", d3.forceManyBody().strength(getChargeForceStrength(displayedGraph.entities.length)))
    .force("collision-force", d3.forceCollide(32).strength(.8))
    // .force("center-force", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX(width / 2).strength(.007))
    .force("y", d3.forceY(height / 2).strength(.007));
  // simulation = cola.d3adaptor().linkDistance(50).size([width, height]);

  simulation
    .nodes(displayedGraph.entities)
    .on("tick", tickActions );

  simulation
    .force("link")
    .links(displayedGraph.relations);

  // This must come after the simulation.links() otherwise the source and target of a relationship return ids, not entities
  var groups = displayedGraph.getSameAsGroups();
  
  hulls.data(groups).enter()
      .append("path");

  simulation.alphaDecay(.02).velocityDecay(.075); // .075

  //update circle positions to reflect node updates on each tick of the simulation
  function tickActions() {
    node
      .attr("transform", function(d) {
        return "translate("
        + Math.max(radius, Math.min(width - radius, d.x))
        + ", "
        + Math.max(radius, Math.min(height - radius, d.y))
        + ")";});
      /*.attr("x", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x)); })
      .attr("y", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); })*/
    link
      .attr("x1", function(d) {return Math.max(radius, Math.min(width - radius, d.source.x));})
      .attr("y1", function(d) {return Math.max(radius, Math.min(height - radius, d.source.y));})
      .attr("x2", function(d) {return Math.max(radius, Math.min(width - radius, d.target.x));})
      .attr("y2", function(d) {return Math.max(radius, Math.min(height - radius, d.target.y));});
    
    d3.select(".hull").selectAll("path").attr("stroke-width", "67px")
        .attr("d", function(d) {return groupPath(d);});
  }
  //for node dragging
  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.1).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
}
// restarts d3 simulation after the displayedGraph has been updated.
function restart() {
  var width = getSimulationDisplaySpaceDimensions()[0],
    height = getSimulationDisplaySpaceDimensions()[1],
    radius = getNodeDefaultRadius();
  
  if (!showSameAsToggled()) {
    if (getCurrentRelationship() != "R40:IS_SAME_AS") {
      console.log("'Show Same As' button is toggled off");
      for (var i = displayedGraph.relations.length - 1; i >= 0; i--) {
        if (displayedGraph.relations[i].type == "R40:IS_SAME_AS") {
          displayedGraph.relations.splice(i,1);
        }
      }
    }
  }

  var node = d3.select(".nodes").selectAll("g");
  node = node.data(displayedGraph.entities, function(d) { return d.id;});
  
  node.exit()
    .select("circle")
      .transition().attr("r", 0);
  node.exit().transition().remove();
  
  enter = node.enter()
    .append("g")
    .on("mouseover", nodeMouseOver)
    .on("mouseout", nodeMouseOut)
    .on("click", nodeClick)
    .on("dblclick", nodeDoubleClick);

  enter._groups[0].forEach(function(element) {
    element.__data__.x = width/2 + Math.cos(Math.random() * 2*Math.PI) * Math.random() * 300;
    element.__data__.y = height/2 + Math.sin(Math.random() * 2*Math.PI) * Math.random() * 300;
  });
  
  enter.call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended));
  
  enter.attr("id", function(d) {return "arrayindex" + d.arrayindex;})
      .attr("arrayindex", function(d) {return d.arrayindex;});
  enter.append("circle")
      .attr("stroke", "#dfdfdf")
      .attr("stroke-width", "2px")
      .attr("fill", function(d) {return colors(d.type); })
      .call(function(node) { node.transition().attr("r", radius); });
  
  enter.append("svg:title")
      .text(function(d) { return d.text; });

  enter.append("text")
      .text(function(d) {
        if (d.text.length > 6) {
          return d.text.substr(0,5) + "...";
        } else {
          return d.text;
        }
      })
      .style("fill", function(d) {return textColors(d.type);})
      .attr("x", function(d) {return getNodeTextPlacement(d.text)[0];} )
      .attr("y", function(d) {return getNodeTextPlacement(d.text)[1];} );
          
  node = enter.merge(node);

  // Apply the general update pattern to the links.
  var link = d3.select(".links").selectAll("line");
  link = link.data(displayedGraph.relations, function(d) { return d.source.id + "-" + d.target.id; });
  
  // Keep the exiting links connected to the moving remaining nodes.
  link.exit().transition()
      .attr("stroke-opacity", 0)
      .attrTween("x1", function(d) { return function() { return d.source.x; }; })
      .attrTween("x2", function(d) { return function() { return d.target.x; }; })
      .attrTween("y1", function(d) { return function() { return d.source.y; }; })
      .attrTween("y2", function(d) { return function() { return d.target.y; }; })
      .remove();
  
  link = link.enter().append("line")
      .call(function(link) { link.transition().attr("stroke-opacity", 1); })
      .attr('marker-end','url(#arrowhead)')
      .style("stroke-width", 4)
      .style("stroke", "black")
      .merge(link)
      .on("mouseover", linkMouseOver)
      .on("mouseout", linkMouseOut)
      .on("click", linkCut);
  d3.select(".links")
    .selectAll("line")
      .attr("id", function(d) {return "linkarrayindex" + d.index;});
  // Update and restart the simulation.
  simulation.force("charge-force", d3.forceManyBody().strength(getChargeForceStrength(displayedGraph.entities.length)));
  simulation.nodes(displayedGraph.entities).on("tick", tickActions);
  simulation.force("link").links(displayedGraph.relations);

  var groups = displayedGraph.getSameAsGroups();
  d3.select(".hull").selectAll("path")
    .data(groups).exit()
    .attr("selection","exit")
    .transition().attr("fill-opacity", 0)
    .transition().attr("stroke-width", "0px");
  d3.select(".hull").selectAll("path").remove();
  // hulls.data(groups).enter()
  //   .append("path");

  simulation.alpha(1).restart();
  console.log("Simulation restarted.");

  if (showSameAsToggled()) {
    sameAsRestart();
  }
  function tickActions() {
    node
      .attr("transform", function(d) {
        return "translate("
        + Math.max(radius, Math.min(width - radius, d.x))
        + ", "
        + Math.max(radius, Math.min(height - radius, d.y))
        + ")";});
    link
      .attr("x1", function(d) {return Math.max(radius, Math.min(width - radius, d.source.x));})
      .attr("y1", function(d) {return Math.max(radius, Math.min(height - radius, d.source.y));})
      .attr("x2", function(d) {return Math.max(radius, Math.min(width - radius, d.target.x));})
      .attr("y2", function(d) {return Math.max(radius, Math.min(height - radius, d.target.y));})
  }
  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }
  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
}
// modified restart for "same as"
function sameAsRestart() {
  var width = getSimulationDisplaySpaceDimensions()[0],
    height = getSimulationDisplaySpaceDimensions()[1],
    radius = getNodeDefaultRadius();
  var node = d3.select(".nodes").selectAll("g");
  var hulls = d3.select(".hull")
      .selectAll("path");
  // Apply the general update pattern to the links.
  var link = d3.select(".links").selectAll("line");
  link = link.data(displayedGraph.relations, function(d) { return d.source.id + "-" + d.target.id; });
  
  // Keep the exiting links connected to the moving remaining nodes.
  link.exit().transition()
  .attr("stroke-opacity", 0)
  .attrTween("x1", function(d) { return function() { return d.source.x; }; })
  .attrTween("x2", function(d) { return function() { return d.target.x; }; })
  .attrTween("y1", function(d) { return function() { return d.source.y; }; })
  .attrTween("y2", function(d) { return function() { return d.target.y; }; })
  .remove();
  
  link = link.enter().append("line")
  .call(function(link) { link.transition().attr("stroke-opacity", .3); })
  .style("stroke-width", 2)
  .style("stroke", "black")
  .merge(link);
  
  // Update and restart the simulation.
  simulation.nodes(displayedGraph.entities).on("tick", tickActions);
  simulation.force("link").links(displayedGraph.relations);
  
  var groups = displayedGraph.getSameAsGroups();
  hulls
    .data(groups)
      .attr("selection","update")
      .attr("d", function(d) {return groupPath(d);});
  hulls
    .data(groups).enter()
    .append("path")
      .attr("selection","enter")
      .attr("d", function(d) {return groupPath(d);})
      .attr("stroke-width", "0px")
      .transition().attr("stroke-width", "67px");
    
  simulation.alpha(1).restart();
  console.log("Simulation restarted showing 'same as'.");

  function tickActions() {
    node
      .attr("transform", function(d) {
        return "translate("
        + Math.max(radius, Math.min(width - radius, d.x))
        + ", "
        + Math.max(radius, Math.min(height - radius, d.y))
        + ")";});
    link
      .attr("x1", function(d) {return Math.max(radius, Math.min(width - radius, d.source.x));})
      .attr("y1", function(d) {return Math.max(radius, Math.min(height - radius, d.source.y));})
      .attr("x2", function(d) {return Math.max(radius, Math.min(width - radius, d.target.x));})
      .attr("y2", function(d) {return Math.max(radius, Math.min(height - radius, d.target.y));});

    d3.select(".hull").selectAll("path")
        // .attr("stroke-width", "0px")
        .attr("d", function(d) {return groupPath(d);});
  }
  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }
  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
}

// key thing about building the displayedGraph is that the entities for each end of a link must
// exist and match the link names precisely otherwise it errors and doesn't show anything
function buildAllData(parsedRelex) {
  var obj = new Object();
  obj.entities = [];
  obj.relations = [];
  obj.getSameAsRels = function() {
    var sameAsRelations = [];
    this.relations.forEach(function(relation) {
      if (relation.type == "R40:IS_SAME_AS") {
        sameAsRelations.push(relation);
      }
    });
    return sameAsRelations;
  };
  obj.getSameAsGroups = function() {
    var sameAsGroups = [];
    this.getSameAsRels().forEach(function(relation) {
      if (sameAsGroups.length > 0) {
        var nodeInGroup = false;
        for (let i = 0; i < sameAsGroups.length; i++) {
          if (sameAsGroups[i].includes(relation.source) || sameAsGroups[i].includes(relation.target)) {
            nodeInGroup = true;
            if (!sameAsGroups[i].includes(relation.source)) {
              sameAsGroups[i].push(relation.source);
            }
            if (!sameAsGroups[i].includes(relation.target)) {
              sameAsGroups[i].push(relation.target);
            }
          }
        }
        if (!nodeInGroup) {
          sameAsGroups.push([relation.source, relation.target]);
        }
      } else { // This handles the first case, when no groups exist yet.
        sameAsGroups.push([relation.source, relation.target]);
      }
    });
    return sameAsGroups;
  };
  obj.getEntityById = function(id) {
    for (let entity of this.entities) {
      if (entity.id == id) {
        return entity;
      }
    }
    return null;
  };
  //We need to look in metadata to add entities because the recognizer sometimes grabs dates and stuff from here
  for (let i in parsedRelex.metadata) {
    var entity = parsedRelex.metadata[i].content;
    for (let j in entity) {
      if (entity[j].tag == "ENAMEX" || entity[j].tag == "TIMEX" || entity[j].tag == "NUMEX") {
        var textentity = entity[j].text.replace(/ \n/g, " ").replace(/\n/g, " ");
        obj.entities.push({tag : entity[j].tag, type : entity[j].type, text : textentity, id : entity[j].offset});
      }
    }
  }
  for (let i in parsedRelex.sbody) {
    var entity = parsedRelex.sbody[i];
    //console.log(entity);
    if (entity.tag == "ENAMEX" || entity.tag == "TIMEX" || entity.tag == "NUMEX") {
      var textentity = entity.text.replace(/ \n/g, " ").replace(/\n/g, " ");
      obj.entities.push({tag : entity.tag, type : entity.type, text : textentity, id : entity.offset});
    }
  }
  for (let i in parsedRelex.relex) {
    var relation = parsedRelex.relex[i];
    //Not sure how to handle the surname relationship thing yet. So just don't add them.
    if (!/S=\d\+|S=\d/.test(relation.type)) {
      obj.relations.push({type : relation.type,
                    startToken : relation.startToken.replace(/ \n/g, " ").replace(/\n/g, " "),
                        source : relation.startOffset,
                      endToken : relation.endToken.replace(/ \n/g, " ").replace(/\n/g, " "),
                        target : relation.endOffset,
                      distance : linkDistance(relation.type)});
    }
  }
  // change node radius depending on number of entities - more => smaller radius, less => larger radius

  // Now we make a copy that adds an index according to the element position in the array, which should follow the order
  // it shows up in the text (for highlighting on hover both ways)
  var copy = new Object();
  copy.entities = [];
  copy.relations = [];
  for (let i in obj.entities) {
    var entity = obj.entities[i];
    copy.entities.push({tag : entity.tag, type : entity.type, text : entity.text, id : entity.id, arrayindex : i});
  }
  for (let i in obj.relations) {
    var relation = obj.relations[i];
    copy.relations.push({ type : relation.type,
                    startToken : relation.startToken,
                        source : relation.source,
                      endToken : relation.endToken,
                        target : relation.target,
                      distance : linkDistance(relation.type)});
  }
  copy.getSameAsGroups = obj.getSameAsGroups;
  copy.getSameAsRels = obj.getSameAsRels;
  copy.getEntityById = obj.getEntityById;
  // copy.getSameAsGroupsForHull = obj.getSameAsGroupsForHull;
  // return obj;
  return copy;
}

</script>